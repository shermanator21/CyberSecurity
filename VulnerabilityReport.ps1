$output = "VulnerabilityReport.txt"
$computerSystem = Get-WmiObject -Class Win32_OperatingSystem
$computerName = $computerSystem.CSName
Write-Output "Checking vulnerabilities on $computerName" | Out-File $output -Append

# Check for missing Windows updates
Write-Output "Checking for missing Windows updates..." | Out-File $output -Append
$missingUpdates = Get-HotFix | Where-Object {$_.HotFixID -notlike "KB*"}
If ($missingUpdates) {
    Write-Output "The following updates are missing:`n" | Out-File $output -Append
    $missingUpdates | Select-Object -Property Description | Out-File $output -Append
} Else {
    Write-Output "No missing updates found." | Out-File $output -Append
}


# Check for open ports
Write-Output "Checking for open ports..." | Out-File $output -Append
$openPorts = Get-NetTCPConnection | Where-Object {$_.State -eq "Listen"} | Select-Object -Property LocalAddress
If ($openPorts) {
    Write-Output "The following ports are open:`n" | Out-File $output -Append
    $openPorts | Out-File $output -Append
} Else {
    Write-Output "No open ports found." | Out-File $output -Append
}

# Check for installed software with known vulnerabilities
Write-Output "Checking for installed software with known vulnerabilities..." | Out-File $output -Append
$installedSoftware = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* | Select-Object -Property DisplayName, DisplayVersion
$vulnerableSoftware = @()
$webClient = New-Object System.Net.WebClient
Foreach ($software in $installedSoftware) {
    $url = "https://nvd.nist.gov/vuln/full-listing?vendor=&product=$($software.DisplayName)&version=$($software.DisplayVersion)&vector=AV:N/AC:L/Au:N/C:P/I:P/A:P"
    Try {
        $html = $webClient.DownloadString($url)
        $vulnerabilities = $html | Select-String "CVSS Base Score"
        If ($vulnerabilities) {
            $vulnerableSoftware += $software
        }
    } Catch {
        Write-Output "Error checking for vulnerabilities in $($software.DisplayName) $($software.DisplayVersion)" | Out-File $output -Append
    }
}
If ($vulnerableSoftware) {
    Write-Output "The following software has known vulnerabilities:`n" | Out-File $output -Append
    $vulnerableSoftware | Out-File $output -Append
} Else {
    Write-Output "No installed software with known vulnerabilities found." | Out-File $output -Append
}

Write-Output "Vulnerability check complete. Results saved to $output."

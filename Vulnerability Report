$output = "VulnerabilityReport.txt"
$computerSystem = Get-WmiObject -Class Win32_OperatingSystem
$computerName = $computerSystem.CSName
Write-Output "Checking vulnerabilities on $computerName" | Out-File $output -Append

# Check for missing Windows updates
$missingUpdates = Get-WmiObject -Class MicrosoftWindowsUpdateAccelerator -Namespace Root\Microsoft\Windows\WindowsUpdate | Where-Object {$_.Downloaded -eq $False}
Write-Output "Checking for missing Windows updates..." | Out-File $output -Append
If ($missingUpdates) {
    Write-Output "The following updates are missing:`n" | Out-File $output -Append
    $missingUpdates | Select-Object -Property Title | Out-File $output -Append
} Else {
    Write-Output "No missing updates found." | Out-File $output -Append
}
Write-Output "`n" | Out-File $output -Append

# Check for open ports
Write-Output "Checking for open ports..." | Out-File $output -Append
$openPorts = Get-NetTCPConnection | Where-Object {$_.State -eq "Listen"} | Select-Object -Property LocalAddress
If ($openPorts) {
    Write-Output "The following ports are open:`n" | Out-File $output -Append
    $openPorts | Out-File $output -Append
} Else {
    Write-Output "No open ports found." | Out-File $output -Append
}
Write-Output "`n" | Out-File $output -Append

# Check for installed software with known vulnerabilities
Write-Output "Checking for installed software with known vulnerabilities..." | Out-File $output -Append
$installedSoftware = Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Uninstall\* | Select-Object -Property DisplayName, DisplayVersion
$vulnerableSoftware = @()
Foreach ($software in $installedSoftware) {
    $vulnerabilities = Invoke-WebRequest -Uri "https://www.cvedetails.com/search-vector.php?vendor=&product=$($software.DisplayName)&version=$($software.DisplayVersion)&vector=AV:N/AC:L/Au:N/C:P/I:P/A:P" | Select-String "CVSS Base Score"
    If ($vulnerabilities) {
        $vulnerableSoftware += $software
    }
}
If ($vulnerableSoftware) {
    Write-Output "The following software has known vulnerabilities:`n" | Out-File $output -Append
    $vulnerableSoftware | Out-File $output -Append
} Else {
    Write-Output "No installed software with known vulnerabilities found." | Out-File $output -Append
}
Write-Output "`n" | Out-File $output -Append

Write-Output "Vulnerability check complete. Results saved in $output."
